---
title: "Shiny Demonstartion"
author: "Brady Johnston"
date: "02/04/2021"
output: 
  html_document:
    code_folding: hide
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```


```{r echo = TRUE, attr.source = c('.numberlines', 'startFrom=12')}
library(shiny)
library(stringr)
library(ggplot2)
library(dplyr)
library(plasmapR)
library(shinyWidgets)

`%>%` <- magrittr::`%>%`

plasmid <- readLines("../data/petm20.gb")

sequence <- extract_sequence(plasmid)

sequence <- paste0(sequence, collapse = "")

feat_df <- create_feature_df(get_features(plasmid))
```


```{r inputs, echo=FALSE}
inputPanel(
  knobInput(
    inputId = "rotation", 
    label = "Rotate Map", 
    value = 90, 
    min = 0, 
    max = 360, 
    step = 1, lineCap = "round", width = "100" 
  ),
  # sliderInput(
  #   inputId = "rotation", 
  #   label = "Rotation Angle (Degrees)", 
  #   min = -180, 
  #   max = 180, 
  #   value = 0, 
  #   step = 1
  # ), 
  sliderInput(
    inputId = "repelBox", 
    label = "Label Spacing Size", 
    min = 0, 
    max = 1, 
    value = 0.3
  ), 
  sliderInput(
    inputId = "labelNudge", 
    label = "Nudge Label Distance", 
    min = 0, 
    max = 2, 
    value = 0.8, 
    step = 0.1
  ), 
  sliderInput(
    inputId = "curve", 
    label = "Label Line Curvature", 
    min = 0, 
    max = 30, 
    value = 10, 
    step = 1
  ), 
  colourpicker::colourInput(
    inputId = "labelTextColour", 
    label = "Label Text Colour", 
    value = "black", 
    showColour = "background"
  ), 
  sliderInput(
    inputId = "zoom", 
    label = "Plasmid Zoom", 
    min = 0, 
    max = 5, 
    value = 3
  ), 
  sliderInput(
    inputId = "textSize", 
    label = "Text Size", 
    min = 1, 
    value = 10,
    max = 20, 
    step = 0.2
  ), 
  checkboxGroupButtons(
    inputId = "features", 
    label = "Features Displayed", 
    choices = unique(feat_df$type), 
    selected = unique(feat_df$type)
  ),
  # selectInput(
  #   inputId = "features", 
  #   label = "Feature Types Shown", 
  #   choices = unique(feat_df$type), 
  #   selected = unique(feat_df$type), 
  #   multiple = TRUE
  # ), 
  textInput(
    inputId = "plasmidName", 
    label = "Plasmid Name", 
    value = "Plasmid Name Here"
  ), 
  sliderInput(
    inputId = "nameSize", 
    label = "Plasmid Name Size", 
    min = 1, 
    max = 10, 
    step = 0.2, 
    value = 3
  )
)
```


```{r plasmap, echo=FALSE}

renderPlot({
  feat_df <- feat_df[feat_df$type %in% input$features, ]
  
  arrow_df <- create_arrow_plotting_df(
    df = feat_df,
    middle = 2,
    width = 0.1,
    arrowhead_size = 4,
    # arrow_cutoff = 0.,
    plasmid_length = nchar(sequence)
  )
  
  angle_adjustment <-
    ifelse(input$rotation < 180, input$rotation, -(360 - input$rotation))
  
  labels <- create_labels(
    feat_df,
    plasmid_length = nchar(sequence),
    spacing_scale = 0.006,
    label_hjust = 0.4,
    rotation = angle_adjustment,
    label_length_cutoff = 0.85
  )
  labels
  # split_text_df(100, 50, "testing", 2)
  
  curve <- input$curve
  
  
  plasmid_plot(
    feat_df,
    features = input$features,
    zoom_y = input$zoom,
    plasmidName = input$plasmidName,
    nameSize = input$nameSize,
    curve = input$curve,
    rotation = input$rotation,
    labelNudge = input$labelNudge,
    labelSize = input$textSize,
    repelBox = input$repelBox,
    plasmid_length = nchar(sequence)
    
  )
},
width = 800,
height = 1000,
res = 75)
```


